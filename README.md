# tosun-geehy-can-uds-bootloader-tool

Десктопное приложение для программирования контроллеров **Geehy APM32** по **CAN/UDS** через отдельный bootloader.

## 1. Назначение проекта

Проект выделен в отдельный репозиторий, чтобы сфокусироваться только на задачах загрузки прошивки:

- подключение к CAN-адаптеру;
- запуск/останов trace;
- загрузка BIN-файла в устройство по UDS-сценарию;
- мониторинг состояния и журнал процесса;
- сервисные команды reset (в bootloader и в основное ПО).

## 2. Технологический стек

- **Python 3.11+**
- **PySide6 (QML)** для UI
- **CAN + UDS + ISO-TP** для протокольной части
- **Geehy APM32** как целевая платформа МК
- **libTSCANAPI** для работы с CAN-адаптером

## 3. Архитектура

### 3.1 Поток управления

1. Пользователь работает с QML-экранами.
2. QML вызывает методы `AppController` (`ui/qml/app_controller.py`).
3. `AppController` координирует:
   - `app_can/CanDevice.py` для CAN-соединения;
   - `uds/bootloader.py` для UDS-сценария программирования;
   - `uds/firmware.py` для загрузки и подготовки BIN.
4. Сигналы из backend возвращаются в QML и обновляют UI/лог/прогресс.

### 3.2 UI-структура

- `ui/qml/Main.qml` — композиция экрана, диалоги, палитра.
- `ui/qml/components/HeaderCard.qml` — шапка и индикаторы статуса.
- `ui/qml/components/ConnectionCard.qml` — CAN-подключение и параметры trace.
- `ui/qml/components/BootloaderCard.qml` — загрузка BIN, запуск программирования, прогресс, лог.
- `ui/qml/components/Fancy*` и вспомогательные компоненты — единый визуальный стиль.

Во всех компонентах добавлены подробные русские комментарии по назначению и контракту.

## 4. Структура каталогов

```text
.
├─ app_can/                 # CAN-уровень и драйверная интеграция
├─ firmware/                # Тестовые/рабочие BIN-файлы
├─ j1939/                   # Вспомогательные протокольные сущности
├─ libTSCANAPI/             # SDK/обертка библиотеки TSCAN
├─ resources/               # Ресурсы интерфейса
├─ uds/                     # UDS bootloader-логика
├─ ui/
│  └─ qml/
│     ├─ Main.qml
│     ├─ app_controller.py
│     └─ components/
├─ main.py
├─ main.spec
└─ requirements.txt
```

## 5. Требования к окружению

- ОС: **Windows** (используется DLL `libTSCAN.dll`)
- Python: **3.11+**
- Подключенный совместимый CAN-адаптер
- Драйверы и библиотека `libTSCANAPI`

## 6. Установка

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

Если в системе несколько версий Python, используйте явный запуск:

```bash
py -3.11 -m venv .venv
```

## 7. Запуск приложения

```bash
.venv\Scripts\python main.py
```

## 8. Рабочий сценарий программирования

1. Нажмите **«Сканировать»** и выберите устройство в списке.
2. Нажмите **«Подключиться»**.
3. При необходимости выберите канал, скорость CAN и терминатор.
4. Нажмите **«Запустить trace»**.
5. Нажмите **«Открыть BIN»** и выберите прошивку.
6. Нажмите **«Начать программирование»**.
7. Контролируйте прогресс и журнал в правой карточке.
8. После завершения при необходимости выполните reset в нужный режим.

## 9. Логирование и состояния

- Верхние статус-чипы показывают:
  - состояние CAN-соединения;
  - состояние trace;
  - активность программирования.
- Журнал в `BootloaderCard` содержит временные метки и цветовое кодирование сообщений.
- Прогресс показывает как абсолютное значение (байты), так и процент.

## 10. Типовые проблемы и диагностика

### 10.1 `ModuleNotFoundError: No module named 'cantools'`

Установите зависимости текущего venv:

```bash
.venv\Scripts\pip install -r requirements.txt
```

### 10.2 Не видно CAN-адаптер

- Проверьте физическое подключение и питание адаптера.
- Убедитесь, что драйвер установлен.
- Проверьте, что `libTSCAN.dll` доступна из `libTSCANAPI/windows/x64`.

### 10.3 Нет обмена с устройством

- Проверьте скорость CAN (125/250/500/1000 кбит/с).
- Проверьте терминатор (в зависимости от топологии шины).
- Проверьте правильность подключения CAN H/CAN L.
- Убедитесь, что устройство переведено в нужный режим bootloader.

## 11. Сборка в exe (опционально)

```bash
pyinstaller main.spec
```

## 12. Рекомендации по развитию

- Добавить отдельный файл конфигурации (последний адаптер, канал, скорость).
- Добавить экспорт журнала в `.log`.
- Добавить автоматическую проверку целостности BIN (CRC/хеш).
- Добавить интеграционные тесты для UDS-сценариев.